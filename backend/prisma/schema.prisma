generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  username      String    @unique @db.VarChar(30)
  email         String?   @unique
  phone         String?   @unique
  passwordHash  String?
  avatarUrl     String?
  bannerUrl     String?
  bio           String?   @db.Text
  status        String?   @db.VarChar(100)
  isOnline      Boolean   @default(false)
  lastSeen      DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sentMessages      Message[]           @relation("sentMessages")
  receivedMessages  Message[]           @relation("receivedMessages")
  chats             ChatParticipant[]
  groups            GroupMember[]
  posts             Post[]
  comments          Comment[]
  stories           Story[]
  followers         Follow[]            @relation("following")
  following         Follow[]            @relation("followers")
  scraps            Scrap[]
  testimonials      Testimonial[]
  reactions         Reaction[]
}

model Chat {
  id          String   @id @default(cuid())
  isGroup     Boolean  @default(false)
  name        String?
  imageUrl    String?
  createdAt   DateTime @default(now())

  participants ChatParticipant[]
  messages     Message[]
}

model ChatParticipant {
  chatId    String
  userId    String
  joinedAt  DateTime @default(now())
  role      String   @default("member") // admin, member

  chat      Chat   @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([chatId, userId])
}

model Message {
  id           String    @id @default(cuid())
  chatId       String
  senderId     String
  content      String?
  type         MessageType @default(TEXT)
  fileUrl      String?
  thumbnailUrl String?
  replyToId    String?
  isDeleted    Boolean   @default(false)
  createdAt    DateTime  @default(now())
  editedAt     DateTime?

  chat     Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender   User      @relation("sentMessages", fields: [senderId], references: [id])
  replyTo  Message?  @relation("replies", fields: [replyToId], references: [id])
  replies  Message[] @relation("replies")
  reactions Reaction[]
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  VOICE
  FILE
  STICKER
  CONTACT
}

model Reaction {
  id        String @id @default(cuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())

  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id])
}

model Post {
  id           String    @id @default(cuid())
  authorId     String
  content      String    @db.Text
  mediaUrls    String[]
  communityId  String?
  visibility   Visibility @default(PUBLIC)
  createdAt    DateTime  @default(now())

  author       User       @relation(fields: [authorId], references: [id])
  community    Community? @relation(fields: [communityId], references: [id])
  likes        Like[]
  comments     Comment[]
}

model Community {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  avatarUrl   String?
  bannerUrl   String?
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())

  members     CommunityMember[]
  posts       Post[]
  moderators  String[]
}

model Story {
  id        String   @id @default(cuid())
  userId    String
  mediaUrl  String
  mediaType String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User       @relation(fields: [userId], references: [id])
  views     StoryView[]
}

model Scrap {
  id        String   @id @default(cuid())
  authorId  String
  targetId  String
  content   String   @db.Text
  createdAt DateTime @default(now())

  author    User @relation(fields: [authorId], references: [id])
  target    User @relation(fields: [targetId], references: [id])
}

enum Visibility {
  PUBLIC
  FRIENDS
  ONLY_ME
}

// ... (Like, Comment, Follow, Testimonial, etc. – todos incluídos no ZIP final)